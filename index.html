<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>パックシミュレーター</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    input {
      padding: 6px;
      font-size: 14px;
      margin-right: 10px;
      width: 100px;
    }
    label {
      font-weight: bold;
      margin-right: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .result {
      white-space: pre-wrap;
      background: #fff;
      padding: 15px;
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    details {
      margin-top: 15px;
      background: #eee;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>パックシミュレーター</h1>

  <div>
    <label>パック総数:</label>
    <input type="number" id="totalTickets" value="31900">
    <label>当たり確率（1/n）:</label>
    <input type="number" id="odds" value="319">
    <label>当たり数:</label>
    <input type="number" id="maxWins" value="100">
  </div>

  <button onclick="simulateLottery()">開始する！</button>
  <div class="result" id="resultArea"></div>

  <script>
    function getSecureRandomInt(max) {
      const array = new Uint32Array(1);
      window.crypto.getRandomValues(array);
      return array[0] % max;
    }

    function simulateLottery() {
      const TOTAL_TICKETS = parseInt(document.getElementById("totalTickets").value);
      const ODDS = parseInt(document.getElementById("odds").value);
      const MAX_WINS = parseInt(document.getElementById("maxWins").value);

      let winRemaining = MAX_WINS;
      let winIndexesSet = new Set();
      let forceStartIndex = null;

      for (let i = 0; i < TOTAL_TICKETS; i++) {
        const currentTicket = i + 1;
        const ticketsLeft = TOTAL_TICKETS - i;

        if (winRemaining >= 1 && winRemaining === ticketsLeft) {
          if (forceStartIndex === null) {
            forceStartIndex = currentTicket;
          }
          winIndexesSet.add(currentTicket);
          winRemaining--;
          continue;
        }

        if (getSecureRandomInt(ODDS) === 0 && winRemaining > 0) {
          winIndexesSet.add(currentTicket);
          winRemaining--;
        }
      }

      let winIndexes = Array.from(winIndexesSet).sort((a, b) => a - b);

      let intervals = [];

      if (winIndexes.length > 0) {
        const firstInterval = winIndexes[0] - 1;
        if (firstInterval > 0) intervals.push(firstInterval);
      }

      for (let i = 1; i < winIndexes.length; i++) {
        const diff = winIndexes[i] - winIndexes[i - 1];
        if (diff > 0) intervals.push(diff);
      }

      if (winIndexes.length > 0) {
        const lastInterval = TOTAL_TICKETS - winIndexes[winIndexes.length - 1];
        if (lastInterval > 0) intervals.push(lastInterval);
      }

      const minInterval = intervals.length > 0 ? Math.min(...intervals) : null;
      const maxInterval = intervals.length > 0 ? Math.max(...intervals) : null;

      let forcedWinCount = 0;
      if (forceStartIndex !== null) {
        forcedWinCount = winIndexes.filter(n => n >= forceStartIndex).length;
      }

      let resultText = `💡 当たりの総数: ${winIndexes.length} / ${MAX_WINS}\n`;
      resultText += winIndexes.length > 0 ? `🎯 最初の当たり: ${winIndexes[0]} 口目\n` : "💥 当たりなし\n";

      if (intervals.length > 0) {
        resultText += `⏱️ 最短の当たり間隔（開始前・終了後も含む）: ${minInterval} 口\n`;
        resultText += `🐢 最長の当たり間隔（開始前・終了後も含む）: ${maxInterval} 口\n`;
      } else {
        resultText += "⚠️ 間隔の計算不可（当たり1件以下）\n";
      }

      if (forceStartIndex !== null) {
        resultText += `🚨 強制排出スタート: ${forceStartIndex} 口目\n`;
        resultText += `🧮 強制排出で出た当たり: ${forcedWinCount} 口\n`;
      } else {
        resultText += `✅ 強制排出は発動しなかった\n`;
      }

      let detailsHTML = '';
      if (winIndexes.length > 0) {
        const indexList = winIndexes.map((n, i) => `${i + 1}回目：${n}口目`).join('\n');
        detailsHTML = `
<details>
  <summary>📋 当たった場所一覧を表示する（${winIndexes.length} 件）</summary>
  <pre>${indexList}</pre>
</details>`;
      }

      document.getElementById("resultArea").innerHTML = resultText + detailsHTML;
    }
  </script>
</body>
</html>
